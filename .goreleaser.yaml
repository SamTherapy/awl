# This is an example .goreleaser.yml file with some sensible defaults.
# Make sure to check the documentation at https://goreleaser.com
before:
  hooks:
    - make clean
    - go mod tidy
    # Make manpages
    - doc/makeman.sh
    # Vendor dependencies
    - go mod vendor

builds:
  - env:
      - CGO_ENABLED=0
    targets:
      - go_first_class
      - plan9_amd64
      - freebsd_amd64

archives:
  - files:
      - LICENCE
      - completions/**
      - doc/awl.1.gz
    name_template: >-
      {{ .ProjectName }}_
      {{- if eq .Os "darwin" }}MacOS_
      {{- else if eq .Os "freebsd" }}FreeBSD_
      {{- else }}{{- title .Os }}_{{ end }}
      {{- .Arch }}
    format_overrides:
      - goos: windows
        format: zip
    rlcp: true
  - files:
      - vendor/**
    id: vendor
    format: tar.xz
    name_template: "{{ .ProjectName }}-{{ .Version }}-deps"
    meta: true
    wrap_in_directory: "{{ .ProjectName }}"
    rlcp: true

universal_binaries:
- replace: true

checksum:
  name_template: "checksums.txt"

snapshot:
  name_template: "{{ incpatch .Version }}-next"

changelog:
  sort: asc

  groups:
    - title: "Dependency Updates"
      regexp: "^.*fix\\(deps\\)*:+.*$"
      order: 2
    - title: "Features"
      regexp: "^.*feat[(\\w)]*:+.*$"
      order: 0
    - title: "Bug fixes"
      regexp: "^.*fix[(\\w)]*:+.*$"
      order: 1
    - title: "Other"
      order: 999

  filters:
    exclude:
      - "^test:"
      - "^docs?:"
      - "typo"
      - "^ci:"

brews:
  - tap:
      owner: sam
      name: homebrew
    homepage: https://dns.froth.zone/awl
    description: A DNS query tool
    license: BSD-3-Clause
    # custom_block: |
    #   head "https://git.froth.zone/sam/awl.git"
    install: |-
      bin.install "awl"
      bash_completion.install "completions/bash.bash" => "awl"
      zsh_completion.install "completions/zsh.zsh" => "_awl"
      fish_completion.install "completions/fish.fish" => "awl.fish"
      man1.install "doc/awl.1.gz"

scoops:
  - bucket:
      owner: sam
      name: scoop
    folder: bucket
    homepage: https://dns.froth.zone/awl
    description: A DNS query client
    license: BSD-3-Clause

nfpms:
  - id: packages
    maintainer: Sam <sam@samtherapy.net>
    homepage: https://dns.froth.zone/awl
    package_name: awl-dns
    description: |-
      Command-line DNS query tool.
      Awl supports DNS-over-[UDP,TCP,HTTPS,QUIC] and DNSCrypt.
    license: BSD-3-Clause
    bindir: /usr/bin
    section: utils
    formats:
      - deb
      - rpm
      - apk
    contents:
      - src: completions/bash.bash
        dst: /usr/share/bash-completion/completions/awl
      - src: completions/zsh.zsh
        dst: /usr/share/zsh/vendor-completions/_awl
        packager: deb
      - src: completions/zsh.zsh
        dst: /usr/share/zsh/site-functions/_awl
        packager: apk
      - src: completions/zsh.zsh
        dst: /usr/share/zsh/site-functions/_awl
        packager: rpm
      - src: completions/fish.fish
        dst: /usr/share/fish/vendor_completions.d/awl.fish
      - src: doc/awl.1.gz
        dst: /usr/share/man/man1/awl.1.gz
      - src: LICENCE
        dst: /usr/share/doc/awl/copyright
    deb:
      lintian_overrides:
        - statically-linked-binary
        - changelog-file-missing-in-native-package

gitea_urls:
  api: https://git.froth.zone/api/v1
  download: https://git.froth.zone
